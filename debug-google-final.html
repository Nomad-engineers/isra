<!DOCTYPE html>
<html>
<head>
    <title>Google OAuth Final Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        button { background: #4285f4; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #3367d6; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Google OAuth Final Test</h1>

    <div class="test-section">
        <h3>Environment Check</h3>
        <div id="env-status">Checking...</div>
    </div>

    <div class="test-section">
        <h3>Google API Status</h3>
        <div id="api-status">Checking...</div>
    </div>

    <div class="test-section">
        <h3>Google OAuth Test</h3>
        <button onclick="testGoogleSignIn()">Test Google Sign-In</button>
        <button onclick="testGooglePrompt()">Test Google Prompt</button>
        <div id="oauth-status">Not tested yet</div>
        <div id="user-info"></div>
    </div>

    <div class="test-section">
        <h3>Backend Test</h3>
        <button onclick="testBackend()">Test Backend Connection</button>
        <div id="backend-status">Not tested yet</div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const clientId = '673993847428-0eo30q2tttk7hajf5cfhrmvs9v03jqll.apps.googleusercontent.com';
        const currentOrigin = window.location.origin;

        // Environment Check
        function checkEnvironment() {
            const envStatus = document.getElementById('env-status');

            envStatus.innerHTML = `
                <p><strong>Client ID:</strong> ${clientId}</p>
                <p><strong>Current Origin:</strong> ${currentOrigin}</p>
                <p><strong>Expected Origins:</strong></p>
                <ul>
                    <li>http://localhost:3000</li>
                    <li>https://your-ngrok-url.com</li>
                </ul>
                <p class="${currentOrigin.includes('localhost') || currentOrigin.includes('ngrok') ? 'success' : 'error'}">
                    ${currentOrigin.includes('localhost') || currentOrigin.includes('ngrok') ?
                    '✅ Origin looks correct for development' :
                    '❌ Origin may not be authorized'}
                </p>
            `;
        }

        // Google API Status
        function checkGoogleAPI() {
            const apiStatus = document.getElementById('api-status');

            fetch(`https://accounts.google.com/gsi/status?client_id=${clientId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`Status: ${response.status} - ${response.statusText}`);
                    }
                })
                .then(data => {
                    apiStatus.innerHTML = `
                        <p class="success">✅ Google API is accessible</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                })
                .catch(error => {
                    apiStatus.innerHTML = `
                        <p class="error">❌ Google API Error: ${error.message}</p>
                        <p><strong>Solutions:</strong></p>
                        <ul>
                            <li>Add "${currentOrigin}" to Authorized JavaScript origins</li>
                            <li>Wait 5-10 minutes after saving changes</li>
                            <li>Check Client ID is correct</li>
                        </ul>
                    `;
                });
        }

        // Test Google Sign-In
        async function testGoogleSignIn() {
            const oauthStatus = document.getElementById('oauth-status');
            const userInfo = document.getElementById('user-info');

            if (!window.google) {
                oauthStatus.innerHTML = '<p class="error">❌ Google API not loaded</p>';
                return;
            }

            oauthStatus.innerHTML = '<p>⏳ Initializing Google Sign-In...</p>';

            try {
                await new Promise((resolve, reject) => {
                    window.google.accounts.id.initialize({
                        client_id: clientId,
                        callback: (response) => {
                            try {
                                // Decode the JWT token
                                const payload = JSON.parse(atob(response.credential.split('.')[1]));

                                userInfo.innerHTML = `
                                    <h4 class="success">✅ Google Sign-In Successful!</h4>
                                    <p><strong>Name:</strong> ${payload.name}</p>
                                    <p><strong>Email:</strong> ${payload.email}</p>
                                    <p><strong>ID:</strong> ${payload.sub}</p>
                                    <p><strong>ID Token:</strong> ${response.credential.substring(0, 50)}...</p>
                                `;

                                oauthStatus.innerHTML = '<p class="success">✅ Google OAuth working!</p>';
                                resolve();
                            } catch (error) {
                                reject(error);
                            }
                        },
                        auto_select: false
                    });
                    resolve();
                });

                // Show the sign-in prompt
                window.google.accounts.id.prompt();

            } catch (error) {
                oauthStatus.innerHTML = `<p class="error">❌ Google Sign-In Error: ${error.message}</p>`;
            }
        }

        // Test Google Prompt
        async function testGooglePrompt() {
            if (!window.google) {
                alert('Google API not loaded');
                return;
            }

            try {
                window.google.accounts.id.initialize({
                    client_id: clientId,
                    callback: (response) => {
                        console.log('Google response:', response);
                        alert('Success! Check console for details.');
                    }
                });

                window.google.accounts.id.prompt();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Test Backend Connection
        async function testBackend() {
            const backendStatus = document.getElementById('backend-status');

            try {
                // Test with a fake token to check if endpoint exists
                const response = await fetch('https://isracms.vercel.app/api/auth/google', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        idToken: 'fake_token_for_testing'
                    }),
                });

                if (response.status === 401 || response.status === 400) {
                    backendStatus.innerHTML = '<p class="success">✅ Backend endpoint exists and responding</p>';
                } else if (response.status === 404) {
                    backendStatus.innerHTML = '<p class="error">❌ Backend endpoint not found (404)</p>';
                } else {
                    backendStatus.innerHTML = `<p>Backend status: ${response.status}</p>`;
                }

            } catch (error) {
                backendStatus.innerHTML = `<p class="error">❌ Backend Error: ${error.message}</p>`;
            }
        }

        // Run checks on page load
        window.addEventListener('load', () => {
            checkEnvironment();
            checkGoogleAPI();
        });
    </script>
</body>
</html>